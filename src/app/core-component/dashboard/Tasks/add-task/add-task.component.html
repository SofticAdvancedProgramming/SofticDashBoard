<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <div class="container px-5">
    <div class="form py-2">
      <div class="form-group my-3">
        <label class="form-label">Task Name</label>
        <div class="row">
          <div class="col-12">
            <input
              type="text"
              formControlName="name"
              class="form-control"
              placeholder="{{ 'TASKS.TASKNAME' | translate }}"
              [ngClass]="{
                'is-invalid':
                form.controls['name'].touched &&
                form.controls['name'].errors,
                'is-valid':
                form.controls['name'].touched &&
                form.controls['name'].errors == null ,
                'is-touched':
                form.controls['name'].untouched &&
                form.controls['name'].errors == null,
            }"
            />
            <div *ngIf="isFieldInvalid('name')" class="text-danger">
              <small *ngIf="form.get('name')?.errors?.['required']">
                {{ "Tasks.validation.nameRequired" | translate }}
              </small>
            </div>
          </div>
        </div>
      </div>

      <div class="row my-3">
        <div class="col-12 form-group">
          <label class="form-label">Task Details</label>
          <textarea
            class="textarea form-control"
            formControlName="taskDetails"
            placeholder="{{ 'TASKS.TASKDETAILS' | translate }}"
            placeholder=""
            [ngClass]="{
              'is-invalid':
              form.controls['taskDetails'].touched &&
              form.controls['taskDetails'].errors,
              'is-valid':
              form.controls['taskDetails'].touched &&
              form.controls['taskDetails'].errors == null ,
              'is-touched':
              form.controls['taskDetails'].untouched &&
              form.controls['taskDetails'].errors == null,
          }"
          ></textarea>
          <div *ngIf="isFieldInvalid('taskDetails')" class="text-danger">
            <small *ngIf="form.get('taskDetails')?.errors?.['required']">
              {{ "Tasks.validation.detailsRequired" | translate }}
            </small>
          </div>
          <div *ngIf="isFieldInvalid('taskDetails')" class="text-danger">
            <small *ngIf="form.get('taskDetails')?.errors?.['minlength']">
              {{ "Tasks.validation.detailsMinLength" | translate }}
            </small>
          </div>
          <div *ngIf="isFieldInvalid('taskDetails')" class="text-danger">
            <small *ngIf="form.get('taskDetails')?.errors?.['maxlength']">
              {{ "Tasks.validation.detailsMaxLength" | translate }}
            </small>
          </div>
        </div>
      </div>

      <div class="row my-3">
        <div class="col-6">
          <div class="form-group">
            <label class="form-label">From (date)</label>
            <input
              [min]="todayDate"
              type="date"
              style="text-transform: lowercase"
              class="form-control"
              formControlName="from"
              [ngClass]="{
              'is-invalid':
              form.controls['from'].touched &&
              form.controls['from'].errors,
              'is-valid':
              form.controls['from'].touched &&
              form.controls['from'].errors == null ,
              'is-touched':
              form.controls['from'].untouched &&
              form.controls['from'].errors == null,
          }"
            />
            <div *ngIf="isFieldInvalid('from')" class="text-danger">
              <small *ngIf="form.get('from')?.errors?.['required']">
                {{ "Tasks.validation.startDateRequired" | translate }}
              </small>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="form-group">
            <label class="form-label">Duration</label>
            <input
              type="number"
              class="form-control"
              formControlName="duration"
              placeholder="Enter Your Duration"
              [ngClass]="{
              'is-invalid':
              form.controls['duration'].touched &&
              form.controls['duration'].errors,
              'is-valid':
              form.controls['duration'].touched &&
              form.controls['duration'].errors == null ,
              'is-touched':
              form.controls['duration'].untouched &&
              form.controls['duration'].errors == null,
          }"
            />
            <div *ngIf="isFieldInvalid('duration')" class="text-danger">
              <small *ngIf="form.get('duration')?.errors?.['required']">
                {{ "Tasks.validation.durationRequired" | translate }}
              </small>
            </div>
          </div>
        </div>
      </div>

      <div class="row my-3">
        <div class="col-12 form-group">
          <label class="form-label">Initial cost</label>
          <div class="custom-input">
            <input
              type="number"
              class="textarea form-control"
              formControlName="initialCost"
              placeholder="{{ 'TASKS.INITIALCOST' | translate }}"
              [ngClass]="{
                'is-invalid':
                form.controls['initialCost'].touched &&
                form.controls['initialCost'].errors,
                'is-valid':
                form.controls['initialCost'].touched &&
                form.controls['initialCost'].errors == null ,
                'is-touched':
                form.controls['initialCost'].untouched &&
                form.controls['initialCost'].errors == null,
            }"
            />

            <img
              src="../../../../../assets/images/dollar-circle.png"
              alt="Icon"
              class="input-icon"
            />
          </div>
          <div *ngIf="isFieldInvalid('initialCost')" class="text-danger">
            <small *ngIf="form.get('initialCost')?.errors?.['required']">
              {{ "Tasks.validation.initialCostRequired" | translate }}
            </small>
          </div>
        </div>
      </div>

      <div class="row my-3">
        <!-- <div class="col-12 form-group">
          <label class="form-label">Actual cost</label>
          <div class="custom-input">
            <input
              type="number"
              class="textarea form-control"
              formControlName="actualCost"
              placeholder="Please write your message no more than 300 words"
              [ngClass]="{
                'is-invalid':
                form.controls['actualCost'].touched &&
                form.controls['actualCost'].errors,
                'is-valid':
                form.controls['actualCost'].touched &&
                form.controls['actualCost'].errors == null ,
                'is-touched':
                form.controls['actualCost'].untouched &&
                form.controls['actualCost'].errors == null,
            }"
            />
            <img
              src="../../../../../assets/images/dollar-circle.png"
              alt="Icon"
              class="input-icon"
            />
          </div>
          <div *ngIf="isFieldInvalid('actualCost')" class="text-danger">
            <small *ngIf="form.get('actualCost')?.errors?.['required']">
              {{ "Tasks.validation.nameRequired" | translate }}
            </small>
          </div>
        </div> -->
      </div>

      <div class="row my-3">
        <div class="form-group toggle-group">
          <label class="switch">
            <input type="checkbox" formControlName="isGlobal" />
            <span class="slider"></span>
          </label>
          <label for="direct-manager" class="toggle-label">{{
            "Assign to all department" | translate
          }}</label>
        </div>
        @if(!form.get('isGlobal')?.value){
        <div class="col-6">
          <div class="form-group">
            <label class="form-label" for="Name">Branch</label>
            <app-drop-down
              [items]="Branches"
              [placeholder]="'Select Branch' | translate"
              [placeholderSearch]="'Search by Name' | translate"
              [itemsLength]="Branches.length"
              (onChange)="onBranchSelect($event)"
              (getNextPageApi)="loadBranches()"
              (search)="loadBranches()"
            >
            </app-drop-down>
          </div>
        </div>
        <div class="col-6">
          <div class="form-group">
            <label class="form-label" for="Name">Departments</label>
            <mat-select
              class="custom-select"
              [placeholder]="'Select Employees'"
              formControlName="EmployeeIds"
              multiple
            >
              <mat-option [value]="null" disabled>{{
                "ToDo.selectEmployee" | translate
              }}</mat-option>
              <mat-option
                *ngFor="let department of departments"
                [value]="department.id"
              >
                {{ department.name }}
              </mat-option>
            </mat-select>
          </div>
        </div>
        }
      </div>

      <div class="row my-3">
        <div class="col-12">
          <div class="form-group">
            <label class="form-label" for="Name">Assign To</label>
            <app-drop-down
              [placeholder]="'Select Employee'"
              [placeholderSearch]="'Search by Name'"
              [items]="employees"
              [currentPage]="employeePage"
              [itemsLength]="employees.length"
              (getNextPageApi)="loadEmployees()"
              (search)="loadEmployees()"
              (onChange)="onEmployeeSelect($event)"
            ></app-drop-down>
            <!-- <mat-select class="custom-select" [placeholder]="'Select Employee'" formControlName="assignEmployee">
              <mat-option [value]="null" disabled>Select Employee</mat-option>
              <mat-option *ngFor="let emp of employees" [value]="emp.id">
                {{ emp.firstName }} {{ emp.lastName }}
              </mat-option>
            </mat-select> -->
          </div>
        </div>
        <!-- <div class="col-6">
          <div class="form-group">
            <label class="form-label">Position</label>
            <input
              type="text"
              class="form-control"
              formControlName="position"
              placeholder="Ui/UX"
            />
          </div>
        </div> -->
      </div>

      <div class="col-12">
        <div class="d-flex gap-1 flex-wrap" style="grid-column: 1 / -1">
          <div class="form-group">
            <label for="photo">{{ "Assets.attachment" | translate }}</label>
            <label for="attachmentfile">
              <div class="container-upload" for="attachmentfile">
                <div
                  *ngIf="
                    !attachmentfileType ||
                    attachmentfileType.startsWith('image/')
                  "
                  class="header"
                >
                  <p>{{ "ASSET_UPLOADER.BROWSE_FILE" | translate }}</p>
                </div>
                <!-- <label for="attachmentfile" class="footer">
                <p *ngIf="files.length === 0 && !attachmentUploadMessage">
                  {{ "ASSET_UPLOADER.NO_FILE_SELECTED" | translate }}
                </p>

                <p *ngIf="attachmentUploadMessage" class="upload-message">
                  {{ attachmentUploadMessage }}
                </p>
              </label> -->

                <input
                  id="attachmentfile"
                  type="file"
                  (change)="onAttachmentChange($event)"
                  formControlName="AssetAttachment"
                  class="form-control-file"
                />
              </div>
            </label>
          </div>
          <div *ngFor="let file of files" class="file-info">
            <div *ngIf="!file.fileType?.startsWith('image/')">
              <i class="fa fa-file" aria-hidden="true"></i>
              <span>{{ file.fileName }}</span>
            </div>

            <img
              *ngIf="file.previewUrl && file.fileType?.startsWith('image/')"
              [src]="file.previewUrl"
              alt="{{ file.fileName }}"
              class="img-preview"
            />
          </div>
          @if(id){
          <img
            *ngFor="let imgFile of taskDetails?.taskAttachments"
            [src]="imgFile.file"
            alt="taskImage"
            class="img-preview"
          />}
        </div>
      </div>

      <div class="col-12">
        <div class="form-group">
          <label for="Name" class="form-label">{{
            "ToDo.taskPriority" | translate
          }}</label>
          <mat-select
            class="custom-select"
            placeholder="{{ 'ToDo.selectPriority' | translate }}"
            formControlName="priority"
          >
            <mat-option [value]="null" disabled>{{
              "ToDo.selectPriority" | translate
            }}</mat-option>
            <mat-option
              *ngFor="let priority of priorities"
              [value]="priority.id"
            >
              {{ priority.name }}
            </mat-option>
          </mat-select>
        </div>
      </div>
    </div>
  </div>

  <div class="container mt-3 py-5 px-5">
    <div class="d-flex justify-content-between align-items-center">
      <p class="lead">{{ "ToDo.toDoTitle" | translate }}</p>
      <button
        class="btn action-btn"
        type="button"
        *ngIf="todos.length == 0"
        (click)="addToDoFun()"
      >
        {{ "ToDo.addToDo" | translate }}
      </button>
    </div>
    <div class="row" formArrayName="todos">
      <div
        class="col-12 form-group"
        *ngFor="let todo of todos.controls; let i = index"
        [formGroupName]="i"
      >
        <label class="form-label">{{
          "ToDo.toDoDescription" | translate
        }}</label>
        <textarea
          class="textarea form-control"
          formControlName="description"
          placeholder="Please write your message no more than 300 words"
          [ngClass]="{
          'is-invalid':
          form.controls['taskToDoDescription'].touched &&
          form.controls['taskToDoDescription'].errors,
          'is-valid':
          form.controls['taskToDoDescription'].touched &&
          form.controls['taskToDoDescription'].errors == null ,
          'is-touched':
          form.controls['taskToDoDescription'].untouched &&
          form.controls['taskToDoDescription'].errors == null,
      }"
        ></textarea>
        <div class="d-flex gap-2">
          <div class="col-6">
            <div class="form-group">
              <label for="Name" class="form-label">{{
                "ToDo.assignTo" | translate
              }}</label>
              <mat-select
                class="custom-select"
                [placeholder]="'Select Employee'"
                formControlName="employeeId"
              >
                <mat-option [value]="null" disabled>{{
                  "ToDo.selectEmployee" | translate
                }}</mat-option>
                <mat-option *ngFor="let emp of employees" [value]="emp.id">
                  {{ emp.firstName }} {{ emp.lastName }}
                </mat-option>
              </mat-select>
              <!-- @else{
              <mat-select formControlName="employeeId">
                <mat-option [value]="null" disabled>Select Employee</mat-option>
                <mat-option
                  *ngFor="let emp of employees"
                  [value]="emp.id"
                >
                  {{ emp.firstName }} {{ emp.lastName }}
                </mat-option>
              </mat-select>
            } -->
            </div>
          </div>
          <div
            class="d-flex col-6 justify-content-center align-items-end bnt-container"
          >
            <button class="btn remove-btn" type="button" (click)="deleteTodo()">
              <img src="../../../../../assets/images/trash.png" alt="remove" />
              {{ "ToDo.remove" | translate }}
              <app-delete-confirmation-pop-up
                *ngIf="isDelete"
                (cancel)="onCancel()"
                (confirm)="removeTodo(i)"
              ></app-delete-confirmation-pop-up>
            </button>
          </div>
        </div>
        <button
          class="btn action-btn"
          type="button"
          *ngIf="todos.length - 1 == i"
          (click)="addToDoFun()"
        >
          {{ "ToDo.addToDo" | translate }}
        </button>
      </div>
    </div>
  </div>

  <div
    class="col-12 d-flex justify-content-center align-items-center py-4 gap-2"
  >
    <button class="btn cancel-btn w-25" routerLink="/">
      {{ "Tasks.addTasks.cancel" | translate }}
    </button>
    <button class="btn action-btn w-25" type="submit">
      @if(id){
      {{ "Tasks.addTasks.save" | translate }}
      }@else{
      {{ "Tasks.addTasks.addTaskBtn" | translate }}
      }
    </button>
  </div>
</form>
